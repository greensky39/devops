# Quest 07. 여러 대의 서버로 서비스 하기

## Introduction

- 이번 퀘스트는 여러 대의 서버를 통해 안정적인 서비스를 만드는 방법을 다룹니다.

## Topics

- Switch

  - L2 Switch

    - 느리고 충돌이 생기는 허브의 단점을 개선하기 위해 프레임을 목적지까지 포워딩 시키는 OSI 레이어 2 맥주소 기반 네트워크 장치를 말한다. 가장 흔히 볼 수 있는 스위칭 방식이고 다른 방식에 비해 저렴하다. 패킷의 맥주소를 읽어 스위칭 시키며 라우팅이 불가능하며, 브로드캐스트 패킷에 의해 성능 저하가 발생한다.
    - OSI : OSI 모형(Open Systems Interconnection Reference Model)은 국제표준화기구(ISO)에서 개발한 모델로, 컴퓨터 네트워크 프로토콜 디자인과 통신을 계층으로 나누어 설명한 것이다. 일반적으로 OSI 7 계층이라고 한다.
    - MAC 주소(Media Access Control Address)는 네트워크 세그먼트의 데이터 링크 계층에서 통신을 위한 네트워크 인터페이스에 할당된 고유 식별자이다. MAC 주소는 이더넷과 와이파이를 포함한 대부분의 IEEE 802 네트워크 기술에 네트워크 주소로 사용된다.
    - 패킷(packet, 문화어: 파케트, 소포)은 정보 기술에서 패킷 방식의 컴퓨터 네트워크가 전달하는 데이터의 형식화된 블록이다. 패킷은 제어 정보와 사용자 데이터로 이루어지며, 이는 페이로드라고도 한다.
    - 라우팅(영어: routing)은 어떤 네트워크 안에서 통신 데이터를 보낼 때 최적의 경로를 선택하는 과정이다. 최적의 경로는 주어진 데이터를 가장 짧은 거리로 또는 가장 적은 시간 안에 전송할 수 있는 경로다. 라우팅은 전화 통신망, 전자 정보 통신망, 그리고 교통망 등 여러 종류의 네트워크에서 사용된다.

    - 장점 : 구조가 간단하고 신뢰성이 높으며 가격이 저렴하고 성능이 좋다.
    - 단점 : 브로드캐스트 패킷에 의해 성능 저하가 발생한다. 라우팅이 불가능하고, 상위 레이어 프로토콜을 이용한 스위칭이 불가능하다.

  - L3 Switch

    - L3 스위치는 서로 다른 네트워크 간의 연결이 가능한 것으로 포트간 패킷 스위칭을 위해 패킷의 IP나 IPX 주소를 읽어서 스위칭을 하며, 통신 경로를 한 번만 설정한다. 해당 프로토콜을 쓰는 패킷에 대해 스위칭이 가능하며, IP나 IPX 주소가 OSI 7 계층 중 3 계층에 해당하기 때문에 레이어 3 스위치라고 한다. L2 스위치에 라우팅 기능을 추가하고, 대부분의 고성능 하드웨어를 기초로 하였으며 기본 구성은 L2와 동일하다.
    - 장점 : 브로드캐스트 트래픽으로 전체 성능 저하를 막을 수 있으며, 트래픽 체크, 가상 랜 등의 많은 부가 기능을 가지고 있다.
    - 단점 : 특정 프로토콜을 이용해야 스위칭을 할 수 있으며, 대부분의 트래픽이 서브넷의 한계를 넘는다.

  - L4 Switch
    - L4 스위치는 로드밸런싱(서버 부하 분산)을 처리하는 장비이다. 외부에서 들어오는 모든 요청은 서버가 아닌 L4 스위치를 거쳐야 하며 모든 요청을 L4 스위치가 받아 서버들에게 적절히 나누어 준다. L4 스위치는 부하 분산뿐만 아니라 UCP, UDP, HTTP와 같은 프로토콜들의 헤더를 분석하여 그 정보를 바탕으로 부하 분산을 실시하고 거기에 더해 소스 IP 혹은 데스티네이션 IP를 NAT 하여 보낼 수 있다.
    - 장점 : 보안성이 높고 고급 스위칭 설정이 가능하여 상황에 따른 적절한 설정을 할 수 있다. 용량에 관계없이 네트워크의 성능 개선에 기여한다.
    - 단점 : 프로토콜에 의존적이며, 설정이 복잡하다. 고가의 장비로 L2, L3 스위치와 적절한 혼합 배치가 필요하다.
  - L7 Switch
    - L7 스위치는 OSI의 7레이어 즉 애플리케이션 레이어에서 동작하는 것으로 이를테면 이메일의 제목이나 문자열을 보고 내용을 파악한다거나 HTTP의 URL 또는 FTP의 파일명, 쿠키 정보, 특정 바이러스의 패턴 등을 분석해서 보안에 더욱 유리하고 더욱 정교한 로드 밸런싱이 가능해진다. L7 스위치는 쉽게 말해 마케팅 용어라고 볼 수 있다.
    - 장점:
      1. 상위 계층에서 로드를 분산하기 때문에 훨씬 더 섬세한 라우팅이 가능함.
      2. 캐싱 기능을 제공함
      3. 비정상적인 트래픽을 사전에 필터링 할 수 있어 서비스 안정성이 높음
    - 단점:
      1. 패킷의 내용을 복호화해야 하기에 더 높은 비용을 지불해야함
      2. 클라이언트가 로드밸런서와 인증서를 공유해야하기 때문에 공격자가 로드밸런서를 통해서 클라이언트 데이터에 접근할 보안상의 위험성이 존재함.

- Load Balancer

  - 리스너

    - 외부의 요청을 받아들이는 역할 ( 사용자의 요청을 받아들이고 적절한 대상그룹으로 라우팅하는 역할 )
    - L4 로드밸런서(스위치)에서 Virtual Server 역할에 해당
    - 서비스 포트(Service Port)를 보유하고 있으며 외부의 요청은 서비스 포트로 접속하는 요청만을 처리

      > 보통 웹 서비스의 경우 80 포트(http)를 사용

    - 로드밸런서에 접근한다는 것은 해당 리스너의 포트로 접근하는 것이기에 리스너는 접근을 위한 리스너 ID에 포트를 명시
    - 한 개의 로드밸런서는 다수의 리스너를 보유할 수 있음
    - 뿐만 아니라 SSL 인증서를 게시하여 SSL Offload를 실시할 수도 있습니다

  - 대상그룹

    - 요청을 분산/전달할 리소스의 집합( 리스너가 전달한 요청을 처리하기 위한 부하분산 대상들의 모임 )
    - L4 로드밸런서(스위치)에서 Pool 에 해당
    - 서비스 포트(Service Port)를 보유하고 있으며 부하 분산 대상인 EC2는 해당 포트가 열려있어야함
    - 대상 그룹의 포트는 꼭 리스너의 포트와 같을 필요는 없다.

      > 요청을 검토한 리스터가 요청이 적합한 경우 대상 그룹에게 이를 전달할 때 대상 그룹의 포트로 Port Translation을 한다.

    - 포함되어 있는 정보
      > 대상 그룹에 등록된 EC2의 각종 정보(인스턴스 ID, Port, AZ)
      > EC2가 전달받은 요청을 처리할 수 있는지를 나타내는 '헬스 체크(Health Check)'
      > 부하 분산 대상인 대상 그룹 내 리소스들은 헬스체크(Health Check)를 활용해 끊임없이 상태를 확인받는다.
      > 요청 처리에 관련된 모니터링(Monitoring)
      > 요청 처리에 관련된 모니터링이라 함은 이 대상 그룹에 요청 처리가 가능한 EC2가 몇 개인지, 불가능한 EC2는 몇 개인지를 뜻함

  - 상태 검사
    > 상태검사는 로드밸런서가 각 인스턴스의 상태가 정상인지 확인하기 위한 요청경로로 주로 GET 방식에 /health로 요청을 하며 응답코드가 200인 경우 인스턴스가 정상임을 확인하다.

## Resources

- [ELB](https://aws.amazon.com/ko/elasticloadbalancing)
- [Single point of failure](https://en.wikipedia.org/wiki/Single_point_of_failure)

## Checklist

- Single Point of Failure는 어떤 개념일까요?
  > 시스템 구성 요소 중에서, 동작하지 않으면 전체 시스템이 중단되는 요소를 말한다.
- 여러 대의 서버로 서비스할 때의 장점은 무엇일까요? 또 주의해야 할 점은 무엇일까요?
  >
- AWS에서 제공하는 로드밸런서에는 어떤 종류가 있나요? 각각의 용도는 무엇일까요?

  > 링크(https://aws.amazon.com/ko/elasticloadbalancing/features/?nc=sn&loc=2)
  > ALB(Application Load Balancer): 유연한 애플리케이션 관리가 필요한 경우.
  > GLB(Gateway Load Balancer):
  > NLB(Network Load Balancer): 애플리케이션에 탁월한 성능 및 고정 IP가 필요한 경우

- AWS 로드밸런서의 리스너 규칙을 이용해 어떤 일들을 할 수 있을까요?
  >
- AWS의 여러 리전(서울, 도쿄 등)으로 로드밸런싱을 하는 것도 가능할까요?
  > 가능할 것 같다.

## Quest

- EC2 인스턴스를 한 대 더 늘리고, 앞단에 ELB를 사용하여 두 대를 로드밸런싱 해 보세요. 직전 퀘스트에서 만들었던 컨테이너를 이용하시면 됩니다.
- 두 대의 서버 모두에 번갈아 요청이 들어오는지 확인해 보세요.
- 만약 한 대의 서버의 컨테이너를 내렸을 때, 자동으로 나머지 한 대의 서버로만 요청이 가게 되도록 설정해 보세요. Application Load Balancer를 이용해서 구현해 봅시다!

## Advanced

- Sticky Session이란 어떤 개념일까요?
  - Sticky Session이란 특정 세션의 요청을 처음 처리한 서버로만 전송하는 것을 의미합니다.
    > 로드 밸런싱이 의도한대로 잘 동작하지 않을 수도 있습니다.
    > 특정 서버만 과부하가 올 수 있습니다.
    > 특정 서버 Fail시 해당 서버에 붙어있는 세션들이 모두 소실될 수 있습니다.
